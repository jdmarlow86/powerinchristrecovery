<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Power in Christ Recovery</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <nav class="site-nav" aria-label="Primary">
    <div class="site-nav__brand">
      <a class="site-nav__home" href="index.html">Power in Christ Recovery</a>
    </div>
    <div class="site-nav__links">
      <a class="site-nav__link site-nav__link--active" href="index.html">Home</a>
      <a class="site-nav__link" href="#affiliates">Affiliates</a>
      <a class="site-nav__link" href="meeting.html">Meetings</a>
    </div>
  </nav>
  <header class="hero">
    <div class="hero__overlay"></div>
    <div class="hero__content container">
      <h1>Power in Christ Recovery</h1>
      <p class="tagline">Finding Strength, Grace, and Renewal in Jesus</p>
      <p class="intro">
        Power in Christ Recovery is a Christ-centered approach to renewal and healing. We believe freedom begins not with
        self-will, but with surrender — and that every struggle can be transformed by God's grace.
      </p>
      <blockquote class="scripture">
        “My grace is sufficient for you, for My power is made perfect in weakness.”<br />
        <cite>— 2 Corinthians 12:9</cite>
      </blockquote>

      <div class="support" data-support>
        <button
          class="support__button"
          type="button"
          aria-haspopup="dialog"
          aria-expanded="false"
          aria-controls="support-modal"
        >
          Support This Ministry
        </button>
        <div
          class="support__content"
          data-support-content
          id="support-modal"
          role="dialog"
          aria-modal="true"
          aria-labelledby="support-modal-title"
          hidden
        >
          <div class="support__panel">
            <h2 class="support__title" id="support-modal-title">Support This Ministry</h2>
            <p class="support__subtitle">Choose your preferred platform:</p>
            <ul class="support__list">
              <li>
                <a
                  class="support__link support__link--cashapp"
                  href="https://cash.app/$jdmarlow"
                  target="_blank"
                  rel="noopener"
                  aria-label="Support via Cash App: $jdmarlow"
                  >Cash App</a
                >
              </li>
              <li>
                <a
                  class="support__link support__link--venmo"
                  href="https://venmo.com/u/Jonathan-Marlow-19"
                  target="_blank"
                  rel="noopener"
                  aria-label="Support via Venmo: @Jonathan-Marlow-19"
                  >Venmo</a
                >
              </li>
              <li>
                <a
                  class="support__link support__link--paypal"
                  href="https://www.paypal.com/paypalme/jdmarlow86"
                  target="_blank"
                  rel="noopener"
                  aria-label="Support via PayPal: @jdmarlow86"
                  >PayPal</a
                >
              </li>
            </ul>
            <p class="support__note" data-hide-in-popup>
              If you don't see a popup window, your browser may have blocked it. The support options are shown here as a fallback.
            </p>
          </div>
        </div>
        <noscript>
          <div class="support__content support__content--static">
            <div class="support__panel">
              <h2 class="support__title">Support This Ministry</h2>
              <p class="support__subtitle">Choose your preferred platform:</p>
              <ul class="support__list">
                <li>
                  <a
                    class="support__link support__link--cashapp"
                    href="https://cash.app/$jdmarlow"
                    target="_blank"
                    rel="noopener"
                    aria-label="Support via Cash App: $jdmarlow"
                    >Cash App</a
                  >
                </li>
                <li>
                  <a
                    class="support__link support__link--venmo"
                    href="https://venmo.com/u/Jonathan-Marlow-19"
                    target="_blank"
                    rel="noopener"
                    aria-label="Support via Venmo: @Jonathan-Marlow-19"
                    >Venmo</a
                  >
                </li>
                <li>
                  <a
                    class="support__link support__link--paypal"
                    href="https://www.paypal.com/paypalme/jdmarlow86"
                    target="_blank"
                    rel="noopener"
                    aria-label="Support via PayPal: @jdmarlow86"
                    >PayPal</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </noscript>
      </div>
    </div>
  </header>

  <main>
    <section class="section container" aria-labelledby="meeting-flow">
      <div class="section__header">
        <h2 id="meeting-flow">Weekly Meeting Flow</h2>
        <p class="section__subtitle">A grace-filled rhythm to gather, share, and grow.</p>
      </div>
      <ol class="list list--numbered">
        <li>Welcome &amp; Opening Prayer</li>
        <li>Scripture Reflection</li>
        <li>Focus Step Discussion</li>
        <li>Group Sharing</li>
        <li>Prayer &amp; Commitment</li>
        <li>Fellowship / Coffee &amp; Support</li>
      </ol>
      <p class="principles">
        <strong>Key Principles:</strong> Confidentiality, listening with grace, and letting Christ lead in love.
      </p>
    </section>

    <section class="section section--muted" aria-labelledby="recovery-steps">
      <div class="container">
        <div class="section__header">
          <h2 id="recovery-steps">The 10 Recovery Steps</h2>
          <p class="section__subtitle">Walk with Christ through a journey of surrender, healing, and mission.</p>
        </div>
        <div class="steps-grid">
          <article class="step-card">
            <h3>1. Surrender &amp; Honesty</h3>
            <p>Admit the struggle and invite God in.</p>
          </article>
          <article class="step-card">
            <h3>2. Safety &amp; Rhythm</h3>
            <p>Create daily spiritual routines.</p>
          </article>
          <article class="step-card">
            <h3>3. Confession &amp; Clean-Up</h3>
            <p>Clear your heart and environment.</p>
          </article>
          <article class="step-card">
            <h3>4. Triggers &amp; Replacement</h3>
            <p>Replace the old with holy focus.</p>
          </article>
          <article class="step-card">
            <h3>5. Scripture &amp; Prayer Habits</h3>
            <p>Feed your spirit daily.</p>
          </article>
          <article class="step-card">
            <h3>6. Community &amp; Mentor</h3>
            <p>Walk with those who lift you up.</p>
          </article>
          <article class="step-card">
            <h3>7. Inventory &amp; Amends</h3>
            <p>Make things right, step by step.</p>
          </article>
          <article class="step-card">
            <h3>8. Boundaries &amp; Guardrails</h3>
            <p>Protect what God restores.</p>
          </article>
          <article class="step-card">
            <h3>9. Service &amp; Mission</h3>
            <p>Turn healing into helping.</p>
          </article>
          <article class="step-card">
            <h3>10. Long-Term Maintenance</h3>
            <p>Remain in Christ; continue growing.</p>
          </article>
        </div>
      </div>
    </section>

    <section class="section container" aria-labelledby="closing-prayer">
      <div class="section__header">
        <h2 id="closing-prayer">Closing Prayer</h2>
      </div>
      <p class="prayer">
        Lord, make me willing to be healed, to walk humbly and rely on Your power. Strengthen my steps, forgive my
        stumbles, and guide me toward lasting freedom. Amen.
      </p>
    </section>

    <section class="section section--chapter" aria-labelledby="create-chapter">
      <div class="container chapter">
        <div class="section__header">
          <h2 id="create-chapter">Create a Chapter</h2>
          <p class="section__subtitle">Bring the Power in Christ Recovery journey to your city or church.</p>
        </div>
        <div class="chapter__grid">
          <div class="chapter__content">
            <p>
              Launching a new chapter begins with prayer, preparation, and a heart to serve. Use these steps to
              establish a grace-filled recovery community where you are:
            </p>
            <ul class="chapter__list">
              <li><strong>Pray &amp; Discern:</strong> Gather a small team committed to interceding for your community.</li>
              <li><strong>Secure a Location:</strong> Partner with a local church or ministry space that can host weekly meetings.</li>
              <li><strong>Equip Your Team:</strong> Review the Power in Christ 10-Step resources and identify leaders for prayer,
                hospitality, and follow-up.</li>
              <li><strong>Share the Vision:</strong> Invite pastors, mentors, and potential participants to learn about the program
                and its Christ-centered approach.</li>
            </ul>
          </div>
          <aside class="chapter__card" aria-labelledby="chapter-contact">
            <h3 id="chapter-contact">Ready to Begin?</h3>
            <p>
              Email us with your location, church or ministry partner, and desired launch timeline. We'll send you
              onboarding materials, coaching support, and promotional tools tailored to your needs.
            </p>
            <p class="chapter__contact">
              <strong>Contact:</strong>
              <a href="mailto:mybiblebelt@gmail.com">mybiblebelt@gmail.com</a>
            </p>
          </aside>
        </div>
      </div>
    </section>

    <section class="section container" id="affiliates" aria-labelledby="affiliates-title">
      <div class="section__header">
        <h2 id="affiliates-title">Affiliates</h2>
        <p class="section__subtitle">Trusted partners walking alongside Power in Christ Recovery.</p>
      </div>
      <div class="affiliates" data-affiliates>
        <div class="affiliates__grid" data-affiliates-list aria-live="polite"></div>
        <p class="affiliates__empty" data-affiliates-empty hidden role="status">
          Affiliate ministries will appear here as they are added.
        </p>
      </div>
      <template id="affiliate-card-template">
        <article class="affiliate-card">
          <div class="affiliate-card__header">
            <h3 class="affiliate-card__title">
              <a class="affiliate-card__link" data-affiliate-link target="_blank" rel="noopener"></a>
            </h3>
            <p class="affiliate-card__tagline" data-affiliate-tagline></p>
          </div>
          <p class="affiliate-card__description" data-affiliate-description></p>
          <div class="affiliate-card__details">
            <a class="affiliate-card__website" data-affiliate-website target="_blank" rel="noopener"></a>
            <p class="affiliate-card__contact" data-affiliate-contact></p>
          </div>
        </article>
      </template>
      <div class="affiliate-admin" data-affiliate-admin-panel>
        <button
          class="affiliate-admin__button"
          type="button"
          data-affiliate-admin
          data-passcode-hash="e703972548e0ded6e8f20c1a874f9700efd87133fb11f8cc0452a4b100a9b691"
          data-passcode-fallback="UG93ZXJJbkNocmlzdEFmZmlsaWF0ZXMyMDI0IQ=="
          aria-expanded="false"
        >
          Admin: Add Affiliate
        </button>
        <form class="affiliate-form" data-affiliate-form hidden novalidate>
          <fieldset class="affiliate-form__fieldset">
            <legend class="affiliate-form__legend">Add Affiliate</legend>
            <div class="affiliate-form__grid">
              <div class="affiliate-form__field">
                <label class="affiliate-form__label" for="affiliate-name">Ministry Name</label>
                <input class="affiliate-form__input" type="text" id="affiliate-name" name="name" required />
              </div>
              <div class="affiliate-form__field">
                <label class="affiliate-form__label" for="affiliate-tagline">Tagline (optional)</label>
                <input class="affiliate-form__input" type="text" id="affiliate-tagline" name="tagline" />
              </div>
              <div class="affiliate-form__field">
                <label class="affiliate-form__label" for="affiliate-website">Website</label>
                <input class="affiliate-form__input" type="url" id="affiliate-website" name="website" required />
              </div>
              <div class="affiliate-form__field">
                <label class="affiliate-form__label" for="affiliate-contact">Contact Email (optional)</label>
                <input class="affiliate-form__input" type="email" id="affiliate-contact" name="contact" />
              </div>
            </div>
            <div class="affiliate-form__field affiliate-form__field--full">
              <label class="affiliate-form__label" for="affiliate-description">Description</label>
              <textarea
                class="affiliate-form__textarea"
                id="affiliate-description"
                name="description"
                rows="4"
                required
              ></textarea>
            </div>
            <div class="affiliate-form__actions">
              <button class="affiliate-form__button" type="submit">Save Affiliate</button>
              <button class="affiliate-form__button affiliate-form__button--secondary" type="button" data-affiliate-cancel>
                Cancel
              </button>
            </div>
            <p class="affiliate-form__hint">
              Use concise, ministry-focused language. Updates save to this browser and appear immediately.
            </p>
            <p class="affiliate-form__feedback" data-affiliate-feedback hidden role="status" aria-live="polite"></p>
          </fieldset>
        </form>
      </div>
    </section>

    <section class="section section--accent" aria-labelledby="connect">
      <div class="container connect">
        <div class="section__header">
          <h2 id="connect">Connect &amp; Next Steps</h2>
        </div>
        <div class="connect__content">
          <ul class="list list--plain">
            <li><strong>Join a meeting:</strong> Your local church or city</li>
            <li><strong>Visit:</strong> <a href="https://mybiblebelt.org/recovery" target="_blank" rel="noopener">mybiblebelt.org/recovery</a></li>
            <li>
              <strong>Online Audio Meeting:</strong>
              <a href="meeting.html">Join our virtual prayer &amp; support space</a>
            </li>
            <li>
              <strong>Start a group:</strong>
              <a href="assets/Recovery_Power_in_Christ_10_Step_Plan.pdf" download>Download the Leader Guide &amp; Journal</a>
            </li>
            <li>
              <strong>Follow-Up Resources:</strong>
              <a href="https://www.bible.com/reading-plans" target="_blank" rel="noopener">Explore a Bible.com reading plan</a>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <section class="section newsletter" aria-labelledby="newsletter">
      <div class="container newsletter__grid">
        <div class="newsletter__content">
          <h2 id="newsletter">Weekly Encouragement in Your Inbox</h2>
          <p>
            Subscribe to receive a short weekly update with prayer prompts, Scripture meditations, and ministry news to help
            you stay rooted in Christ throughout the week.
          </p>
        </div>
        <form class="newsletter__form" data-newsletter-form novalidate>
          <label class="newsletter__label" for="newsletter-email">Email address</label>
          <div class="newsletter__field">
            <input
              class="newsletter__input"
              type="email"
              id="newsletter-email"
              name="email"
              placeholder="you@example.com"
              autocomplete="email"
              required
            />
            <button class="newsletter__button" type="submit">Sign Up</button>
          </div>
          <p class="newsletter__privacy">We'll send one email each week. Unsubscribe at any time.</p>
          <p class="newsletter__confirmation" data-newsletter-message hidden role="status" aria-live="polite">
            Thanks for subscribing! Please check your inbox for a welcome message.
          </p>
          <p class="newsletter__error" data-newsletter-error hidden role="status" aria-live="assertive">
            Sorry, we couldn't send your welcome email. Please try again in a moment.
          </p>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; <span id="year"></span> Power in Christ Recovery. All rights reserved.</p>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const support = document.querySelector('[data-support]');
    if (support) {
      const button = support.querySelector('.support__button');
      const content = support.querySelector('[data-support-content]');
      let previousPopup = null;

      if (!button || !content) {
        if (content) {
          content.hidden = false;
          content.removeAttribute('hidden');
        }
      } else {
        const stylesheet = document.querySelector('link[rel="stylesheet"][href$="styles.css"]');

        const getPopupMarkup = () => {
          const clone = content.cloneNode(true);
          clone.removeAttribute('hidden');
          clone.querySelectorAll('[data-hide-in-popup]').forEach((node) => node.remove());
          return clone.innerHTML;
        };

        const showInlineSupport = () => {
          content.hidden = false;
          content.removeAttribute('hidden');
          button.setAttribute('aria-expanded', 'true');
        };

        const hideInlineSupport = () => {
          content.hidden = true;
          content.setAttribute('hidden', '');
          button.setAttribute('aria-expanded', 'false');
        };

        const openSupportWindow = () => {
          const width = 480;
          const height = 520;
          const left = Math.round(window.screenX + Math.max((window.outerWidth - width) / 2, 0));
          const top = Math.round(window.screenY + Math.max((window.outerHeight - height) / 2, 0));
          const features = `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`;
          if (previousPopup && !previousPopup.closed) {
            try {
              previousPopup.close();
            } catch (error) {
              console.error('Unable to close previous support window:', error);
            }
          }

          const popupName = `supportOptions-${Date.now()}`;
          const popup = window.open('', popupName, features);

          if (!popup) {
            return null;
          }

          const markup = getPopupMarkup();
          const stylesheetHref = stylesheet ? stylesheet.getAttribute('href') : null;

          try {
            popup.document.open();
            popup.document.write(`<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Support This Ministry</title>
    ${stylesheetHref ? `<link rel="stylesheet" href="${stylesheetHref}">` : ''}
  </head>
  <body class="support__window">
    <main class="support__window-main">
      ${markup}
    </main>
  </body>
</html>`);
            popup.document.close();

            popup.addEventListener('load', () => {
              const firstLink = popup.document.querySelector('.support__list a');
              if (firstLink) {
                firstLink.focus();
              }
            });

            popup.focus();
            previousPopup = popup;
            return popup;
          } catch (error) {
            console.error('Unable to render support window:', error);
            try {
              popup.close();
            } catch (closeError) {
              console.error('Unable to close failed support window:', closeError);
            }
            return null;
          }
        };

        button.addEventListener('click', () => {
          const popup = openSupportWindow();

          if (!popup) {
            if (content.hasAttribute('hidden')) {
              showInlineSupport();
            } else {
              hideInlineSupport();
            }
          } else {
            hideInlineSupport();
          }
        });
      }
    }

    window.addEventListener('unhandledrejection', (event) => {
      const reason = event?.reason;
      if (reason && /MetaMask extension not found/i.test(reason.message || reason)) {
        event.preventDefault();
        console.info('MetaMask extension not detected; wallet connection skipped.');
      }
    });

    const newsletterForm = document.querySelector('[data-newsletter-form]');
    if (newsletterForm) {
      const emailInput = newsletterForm.querySelector('input[type="email"]');
      const message = newsletterForm.querySelector('[data-newsletter-message]');
      const errorMessage = newsletterForm.querySelector('[data-newsletter-error]');
      const submitButton = newsletterForm.querySelector('button[type="submit"]');
      const submitButtonLabel = submitButton ? submitButton.textContent : '';

      const toggleMessage = (element, shouldShow) => {
        if (!element) return;
        element.hidden = !shouldShow;
      };

      const sendWelcomeEmail = async (emailAddress) => {
        const endpointBase = 'https://formsubmit.co/ajax/';
        const welcomeLines = [
          'Hi there,',
          '',
          'Thank you for signing up to receive weekly encouragement from Power in Christ Recovery.',
          'We are honored to walk alongside you in prayer, Scripture reflection, and Christ-centered support.',
          '',
          'Each week you can expect:',
          '• A short devotional focus rooted in God\'s Word.',
          '• A prayer prompt to carry with you through the week.',
          '• Ministry updates and opportunities to stay connected.',
          '',
          'We are praying for you. May the peace of Christ guard your heart as you continue this journey toward freedom.',
          '',
          'Grace and peace,',
          'Power in Christ Recovery'
        ];

        const payload = {
          email: emailAddress,
          message: welcomeLines.join('\n'),
          _subject: 'Welcome to Power in Christ Recovery',
          _bcc: 'jonmarlow@gmail.com',
          _template: 'table'
        };

        const response = await fetch(`${endpointBase}${encodeURIComponent(emailAddress)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error('Failed to send welcome email');
        }

        return response.json();
      };

      newsletterForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (emailInput && !emailInput.checkValidity()) {
          emailInput.reportValidity();
          return;
        }

        const emailAddress = emailInput ? emailInput.value.trim() : '';
        if (!emailAddress) {
          return;
        }

        toggleMessage(message, false);
        toggleMessage(errorMessage, false);

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Sending…';
        }

        try {
          await sendWelcomeEmail(emailAddress);
          newsletterForm.reset();
          toggleMessage(message, true);
        } catch (error) {
          console.error('Newsletter signup error:', error);
          toggleMessage(errorMessage, true);
          if (emailInput) {
            emailInput.focus();
          }
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = submitButtonLabel;
          }

          window.setTimeout(() => {
            toggleMessage(message, false);
            toggleMessage(errorMessage, false);
          }, 8000);
        }
      });
    }

    const affiliateSection = document.querySelector('[data-affiliates]');
    if (affiliateSection) {
      const AFFILIATE_STORAGE_KEY = 'picr:affiliates';
      const AFFILIATE_ADMIN_KEY = 'picr:affiliates-admin';
      const list = affiliateSection.querySelector('[data-affiliates-list]');
      const emptyState = affiliateSection.querySelector('[data-affiliates-empty]');
      const template = document.getElementById('affiliate-card-template');
      const adminButton = affiliateSection.querySelector('[data-affiliate-admin]');
      const form = affiliateSection.querySelector('[data-affiliate-form]');
      const feedback = affiliateSection.querySelector('[data-affiliate-feedback]');
      const cancelButton = affiliateSection.querySelector('[data-affiliate-cancel]');
      const passcodeHash = adminButton ? adminButton.dataset.passcodeHash : '';
      const passcodeFallback = adminButton ? adminButton.dataset.passcodeFallback : '';

      const storage = {
        read(key) {
          try {
            return window.localStorage.getItem(key);
          } catch (error) {
            console.warn('Affiliate storage read failed:', error);
            return null;
          }
        },
        write(key, value) {
          try {
            window.localStorage.setItem(key, value);
          } catch (error) {
            console.warn('Affiliate storage write failed:', error);
          }
        },
        remove(key) {
          try {
            window.localStorage.removeItem(key);
          } catch (error) {
            console.warn('Affiliate storage remove failed:', error);
          }
        }
      };

      const defaultAffiliates = [
        {
          name: 'MyBibleBelt.org',
          tagline: 'Regional discipleship resources for lasting freedom.',
          description:
            'MyBibleBelt.org provides Christ-centered recovery tools, live prayer gatherings, and on-demand discipleship support for churches and leaders across the southeastern United States.',
          website: 'https://mybiblebelt.org',
          contact: 'mybiblebelt@gmail.com'
        }
      ];

      const parseStoredAffiliates = () => {
        const stored = storage.read(AFFILIATE_STORAGE_KEY);
        if (!stored) return null;
        try {
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : null;
        } catch (error) {
          console.warn('Affiliate storage parse failed:', error);
          return null;
        }
      };

      const persistAffiliates = (items) => {
        storage.write(AFFILIATE_STORAGE_KEY, JSON.stringify(items));
      };

      let affiliates = parseStoredAffiliates() || defaultAffiliates.slice();
      let feedbackTimer = null;

      const clearFeedback = () => {
        if (feedbackTimer) {
          window.clearTimeout(feedbackTimer);
          feedbackTimer = null;
        }

        if (feedback) {
          feedback.textContent = '';
          feedback.hidden = true;
          feedback.removeAttribute('data-state');
        }
      };

      const showFeedback = (message, state = 'success', persist = false) => {
        if (!feedback) {
          return;
        }

        if (feedbackTimer) {
          window.clearTimeout(feedbackTimer);
          feedbackTimer = null;
        }

        feedback.textContent = message;
        feedback.hidden = false;

        if (state) {
          feedback.dataset.state = state;
        } else {
          feedback.removeAttribute('data-state');
        }

        if (!persist) {
          const duration = state === 'error' ? 8000 : 6000;
          feedbackTimer = window.setTimeout(() => {
            clearFeedback();
          }, duration);
        }
      };

      const normalizeUrl = (value) => {
        if (!value) return '';
        const trimmed = value.trim();
        if (!trimmed) return '';
        if (/^https?:\/\//i.test(trimmed)) {
          return trimmed;
        }
        return `https://${trimmed}`;
      };

      const renderAffiliates = (items) => {
        if (!list || !template) return;
        list.innerHTML = '';

        if (!items || items.length === 0) {
          if (emptyState) {
            emptyState.hidden = false;
          }
          return;
        }

        if (emptyState) {
          emptyState.hidden = true;
        }

        items.forEach((affiliate) => {
          const card = template.content.firstElementChild.cloneNode(true);
          const link = card.querySelector('[data-affiliate-link]');
          const tagline = card.querySelector('[data-affiliate-tagline]');
          const description = card.querySelector('[data-affiliate-description]');
          const website = card.querySelector('[data-affiliate-website]');
          const contact = card.querySelector('[data-affiliate-contact]');

          if (link) {
            link.textContent = affiliate.name;
            const href = normalizeUrl(affiliate.website);
            if (href) {
              link.href = href;
            } else {
              link.removeAttribute('href');
              link.removeAttribute('target');
              link.removeAttribute('rel');
            }
          }

          if (tagline) {
            if (affiliate.tagline) {
              tagline.textContent = affiliate.tagline;
              tagline.hidden = false;
            } else {
              tagline.hidden = true;
            }
          }

          if (description) {
            description.textContent = affiliate.description || '';
          }

          if (website) {
            const href = normalizeUrl(affiliate.website);
            if (href) {
              website.href = href;
              website.textContent = href.replace(/^https?:\/\//i, '');
              website.hidden = false;
            } else {
              website.hidden = true;
            }
          }

          if (contact) {
            if (affiliate.contact) {
              const emailLink = document.createElement('a');
              emailLink.href = `mailto:${affiliate.contact}`;
              emailLink.textContent = affiliate.contact;
              contact.textContent = 'Contact: ';
              contact.append(emailLink);
              contact.hidden = false;
            } else {
              contact.hidden = true;
            }
          }

          list.appendChild(card);
        });
      };

      renderAffiliates(affiliates);

      const hashValue = async (value) => {
        if (!value) return '';
        if (window.crypto && window.crypto.subtle) {
          const encoder = new TextEncoder();
          const data = encoder.encode(value);
          const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
          return Array.from(new Uint8Array(hashBuffer))
            .map((byte) => byte.toString(16).padStart(2, '0'))
            .join('');
        }

        if (passcodeFallback) {
          try {
            const decoded = atob(passcodeFallback);
            return value === decoded ? passcodeHash : '';
          } catch (error) {
            console.warn('Affiliate admin fallback decode failed:', error);
          }
        }

        return '';
      };

      let isAdmin = storage.read(AFFILIATE_ADMIN_KEY) === 'granted';

      const openAdminForm = () => {
        if (!form || !adminButton) return;
        form.hidden = false;
        adminButton.setAttribute('aria-expanded', 'true');
        adminButton.textContent = 'Admin: Hide Form';
      };

      const closeAdminForm = () => {
        if (!form || !adminButton) return;
        form.reset();
        form.hidden = true;
        adminButton.setAttribute('aria-expanded', 'false');
        adminButton.textContent = 'Admin: Add Affiliate';
        clearFeedback();
      };

      if (form && !isAdmin) {
        form.hidden = true;
      }

      if (isAdmin) {
        openAdminForm();
      }

      if (adminButton) {
        adminButton.addEventListener('click', async () => {
          if (!form) {
            return;
          }

          if (!isAdmin) {
            const input = window.prompt('Enter the admin passcode to manage affiliates:');
            if (!input) {
              return;
            }

            try {
              const hashed = await hashValue(input.trim());
              const matches = hashed === passcodeHash;

              if (matches) {
                isAdmin = true;
                storage.write(AFFILIATE_ADMIN_KEY, 'granted');
                openAdminForm();
                clearFeedback();
                showFeedback('Admin mode enabled. Add your affiliate details below.');
              } else {
                showFeedback('Incorrect passcode. Please try again.', 'error');
              }
            } catch (error) {
              console.error('Affiliate admin verification failed:', error);
              showFeedback('Unable to verify passcode. Please try again.', 'error');
            }
            return;
          }

          if (form.hidden) {
            openAdminForm();
          } else {
            closeAdminForm();
          }
        });
      }

      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          closeAdminForm();
        });
      }

      if (form) {
        form.addEventListener('submit', (event) => {
          event.preventDefault();

          if (!isAdmin) {
            showFeedback('You need the admin passcode to add affiliates.', 'error');
            return;
          }

          clearFeedback();

          const formData = new FormData(form);
          const affiliate = {
            name: (formData.get('name') || '').toString().trim(),
            tagline: (formData.get('tagline') || '').toString().trim(),
            website: (formData.get('website') || '').toString().trim(),
            contact: (formData.get('contact') || '').toString().trim(),
            description: (formData.get('description') || '').toString().trim()
          };

          if (!affiliate.name || !affiliate.description || !affiliate.website) {
            showFeedback('Name, website, and description are required.', 'error');
            return;
          }

          affiliates.push(affiliate);
          renderAffiliates(affiliates);
          persistAffiliates(affiliates);
          form.reset();
          showFeedback(`${affiliate.name} was added to the affiliate list.`);
        });
      }
    }
  </script>
</body>
</html>
